# This Makefile creates PasDoc generated documentation for PasDoc itself.
# Documentation is created in subdirectories named after pasdoc's --format
# names (html/, latex/ etc.)
#
# Includes a Classes and Uses hierarchy graph (requires GraphViz).
# TODO: for now this GraphViz graph's are only included in Html output.
#
# Targets:
#
#   html latex pdf dvi ps html-latex
#     Make documentation in requested format.
#
#   clean
#     Delete all generated documentation.
#
#   public
#     Generate documentation in all formats that we want to show
#     on http://pasdoc.sourceforge.net/autodoc/.
#
#   upload
#     Upload documentation generated by `public'
#     to http://pasdoc.sourceforge.net/autodoc/.
#     Of course you need to have sourceforge account and sufficient privileges
#     on sourceforge shell server to do this.
#     It uses scp program. You will be asked for password (more than once)
#     unless you configured ssh keys for your sourceforge account,
#     so configuring ssh keys is really advised.
#     You should override SF_USERNAME variable at command-line to your
#     username on sourceforge.
#
#     Note that scp displays progress meter on output, if you don't want this
#     (e.g. because you run make into Emacs compilation buffer)
#     you can pass option `-q' to scp, calling make like this
#     `make upload SCP_OPTIONS=-q SF_USERNAME=my_user_name'
#
#     For the sake of other pasdoc developers that would like
#     to also be able to execute `make upload' to upload freshest
#     version of autodoc, this target at the end gives write
#     permissions for the group `pasdoc' to all uploaded files.
#
# Some hints:
#   To completely remake all documentation for
#   http://pasdoc.sourceforge.net/autodoc/
#   just call `make clean public upload SF_USERNAME=my_user_name'

# Making documentation ----------------------------------------

# TODO: It would be nice if this part of Makefile would share some
# source with Makefile in ../../tests/Makefile

# Name of pasdoc binary.
# Remember you can override it at make's command-line, like `make PASDOC=pasdoc'
PASDOC=../console/PasDoc_Console

# These options will be passed to every pasdoc invocation,
# i.e. for every output format.
PASDOC_OPTIONS=--include ../component \
  ../component/*.pas ../OptionParser/*.pas \
  --title "PasDoc's autodoc" --write-uses-list

.PHONY: html latex pdf dvi ps html-latex clean

html:
	mkdir -p html/
	$(PASDOC) $(PASDOC_OPTIONS) \
	  --graphviz-classes --graphviz-uses \
	  --link-gv-classes jpg --link-gv-uses jpg \
	  --output=html/
	dot -Tjpg -ohtml/GVClasses.jpg html/GVClasses.dot
	dot -Tjpg -ohtml/GVUses.jpg html/GVUses.dot

# Just shortcuts
latex: latex/docs.tex
pdf: latex/docs.pdf
dvi: latex/docs.dvi
ps: latex/docs.ps
html-latex: latex/docs.html

latex/docs.tex:
	mkdir -p latex/
	$(PASDOC) $(PASDOC_OPTIONS) \
	  --format=latex --output=latex/

# (Yes, I must do `cd latex' before calling pdflatex, I can't simply call
# `pdflatex latex/docs.tex' because then many output files of pdflatex
# would be placed in current dir)
latex/docs.pdf: latex/docs.tex
	cd latex; pdflatex --file-line-error-style -interaction=nonstopmode docs.tex
	cd latex; pdflatex --file-line-error-style -interaction=nonstopmode docs.tex

latex/docs.dvi: latex/docs.tex
	cd latex; latex --file-line-error-style -interaction=nonstopmode docs.tex
	cd latex; latex --file-line-error-style -interaction=nonstopmode docs.tex

latex/docs.ps: latex/docs.dvi
	cd latex; dvips docs.dvi -o docs.ps

# When working htlatex overrides latex/docs.dvi with a version
# that is not really a useful to browse (it's only for htlatex internals).
# That's why I `rm' it afterwards.
latex/docs.html: latex/docs.tex
	cd latex; htlatex docs.tex
	cd latex; htlatex docs.tex
	rm latex/docs.dvi

clean:
	rm -Rf html/ latex/ latex2rtf/ htmlhelp/

# ------------------------------------------------------------
# Making and uploading autodoc for http://pasdoc.sourceforge.net/autodoc/

.PHONY:	public upload

public: html pdf latex html-latex

# Override this at command-line to your username,
# like `make upload SF_USERNAME=my_user_name'
SF_USERNAME=kambi

SF_HOST=shell.sourceforge.net
SF_PATH=/home/groups/p/pa/pasdoc/htdocs/autodoc/

SF_CONNECT=$(SF_USERNAME)@$(SF_HOST):$(SF_PATH)

SCP_OPTIONS=

upload:
	scp $(SCP_OPTIONS) latex/docs.pdf $(SF_CONNECT)latex/
	scp $(SCP_OPTIONS) latex/docs.tex $(SF_CONNECT)latex/
	scp $(SCP_OPTIONS) latex/docs.html $(SF_CONNECT)latex/
	scp $(SCP_OPTIONS) latex/docs.css $(SF_CONNECT)latex/
	scp $(SCP_OPTIONS) -r html/ $(SF_CONNECT)
	../../tests/scripts/ssh_chmod_writeable_by_pasdoc.sh \
	  $(SF_USERNAME) $(SF_PATH)

# eof ------------------------------------------------------------